services:
  api:
    build:
      context: .
      target: api
    # API is internal-only; access via nginx on port 8765
    # Uncomment below to expose API directly for debugging:
    # ports:
    #   - "3456:3456"
    volumes:
      - ./data:/app/data
      - ./storage:/app/storage
    environment:
      - NODE_ENV=production
      - PORT=3456
      - HOST=0.0.0.0
      - DATABASE_PATH=/app/data/cards.db
      - STORAGE_PATH=/app/storage
      # Size limits use generous defaults from config.ts (300MB card/png, 500MB uncompressed ZIP)
      # Trust nginx proxy for rate limiting (1 hop)
      - TRUST_PROXY=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3456/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3

  web:
    build:
      context: .
      target: web
    ports:
      - "8765:80"
    depends_on:
      - api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  data:
  storage:
